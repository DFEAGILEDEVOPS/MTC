# Sync results to SQL (Throttled function)

This function runs from nightly timer trigger and will process the entire `check-completion` Service Bus queue.  A message is placed on the queue for every check marked, and contains the marked check data and the entire uncompressed received check.

This function is run as a throttled function, where only a low number of  processes will run concurrently.  This means the function will take several hours to run through the entire queue. 

## Inputs

* Azure service bus queue

## Outputs

* SQL Server
    * `mtc.results` schema

## Data copied

* Check mark
* Answers provided

## Data transformed

* none

## Error handling

Messages will be re-reprocessed up to 10 times.

## Consumers

This data is used to provide the Data Team with raw result data.  This data is used to generate reports for the data team and the psychometricians.

## Timing

This function is expected to take several hours to process a full queue on a busy day (100K messages).

## Notes

`browerTimestamps` are timestamp fields generated by the browser, and so stored in UTC.  When these timestamps are inserted into a datetimeoffset field they are converted to the local timezone the server is runnning in.  If this timezone is Europe/London, then the datetime entries will correspond to local time the pupil's took the check.  However, caution is advised as some pupils will be in other timezones. Check the school's SCE entry for details.