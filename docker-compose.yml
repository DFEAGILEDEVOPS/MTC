version: '3'
services:
  sqldb:
    image: "mcr.microsoft.com/mssql/server:2019-GA-ubuntu-16.04"
    container_name: mtc_mssql
    ports:
      - "1433:1433"
    environment:
      SA_PASSWORD: "Mtc-D3v.5ql_S3rv3r"
      ACCEPT_EULA: "Y"
      HOMEBREW_NO_ENV_FILTERING: 1
  functions_base:
    build: ./deploy/docker/functions-base
    command: echo "mtc-functions-base built"
  migration:
    build:
      context: ./admin
      dockerfile: dev.Dockerfile
    container_name: mtc_admin_dev_migration
    volumes:
      - "./:/mtc"
    environment:
      SQL_SERVER: 'sqldb'
      SQL_PORT: '1433'
    depends_on:
      - sqldb
    command: /bin/bash /mtc/admin/run-dev-migrations.sh
  redis:
    image: "redis:4.0-alpine"
    container_name: mtc_redis
    ports:
      - "6379:6379"
    depends_on:
      - sqldb
      - migration
  functions_app:
    build: ./functions-app
    container_name: "mtc_functions_app"
    ports:
      - 7072:7072
    volumes:
      - "./:/mtc"
    environment:
      SQL_SERVER: 'sqldb'
      REDIS_HOST: 'redis'
    depends_on:
      - sqldb
      - migration
      - redis
    command: ["./wait-for-db.sh", "sqldb", "yarn", "start"]
  func_consumption:
    build: ./func-consumption
    container_name: "mtc_func_consumption"
    ports:
      - 7071:7071
    volumes:
      - "./:/mtc"
    environment:
      SQL_SERVER: 'sqldb'
      REDIS_HOST: 'redis'
    depends_on:
      - sqldb
      - migration
      - redis
    command: ["./wait-for-db.sh", "sqldb", "yarn", "start"]
  admin_dev:
      build:
        context: ./admin
        dockerfile: dev.Dockerfile
      container_name: "mtc_admin_dev"
      ports:
        - 3001:3001
      volumes:
        - "./:/mtc"
      environment:
        SQL_SERVER: 'sqldb'
        REDIS_HOST: 'redis'
      depends_on:
        - sqldb
        - migration
        - redis
      restart: always
      command: ["./wait-for-db.sh", "sqldb", "./docker-start-dev.sh"]
  spa_dev:
    build:
      context: ./pupil-spa
      dockerfile: dev.Dockerfile
    container_name: "mtc_spa_dev"
    ports:
      - 4200:4200
    volumes:
      - "./:/mtc"
    environment:
      REDIS_HOST: 'redis'
    depends_on:
      - sqldb
      - migration
      - redis
    command: ["./docker-start-dev.sh"]
