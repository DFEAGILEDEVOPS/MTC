resources:
- repo: self
  clean: true
phases:
- phase: Phase_1
  displayName: Admin Image

  condition: succeeded()
  queue:
    name: MTC LIVE
    demands: sh

  steps:
  - task: ShellScript@2
    displayName: 'create build and commit details file'
    inputs:
      scriptPath: 'admin/vso-add-build-and-commit.sh'

      failOnStandardError: true

  - task: Docker@
    displayName: 'Create Image'
    inputs:
      azureSubscription: 'MTC EE Dev'

      azureContainerRegistry: '$(CONTAINER_REGISTRY_URL)'

      dockerFile: admin/Dockerfile

      imageName: '$(ADMIN_IMAGE_NAME):$(Build.BuildNumber)'

      includeSourceTags: true

      includeLatestTag: true

  - task: Docker@1
    displayName: 'Publish Admin Image'
    inputs:
      azureSubscription: 'MTC EE Dev'

      azureContainerRegistry: '$(CONTAINER_REGISTRY_URL)'

      action: 'Push an image'

      imageName: '$(ADMIN_IMAGE_NAME):$(Build.BuildNumber)'

      includeSourceTags: true

      includeLatestTag: true

    timeoutInMinutes: 30
