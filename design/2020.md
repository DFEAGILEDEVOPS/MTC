# Design proposals for 2020 architecture

## Current key design questions
- receivedCheck: composite index school uuid/pupil uuid only allows one check to be stored
- restart: could require an existing receivedCheck to be overwritten / invalidated
  - insertOrUpdate rather than insertOrMerge as we want any prior validation/marking data to be removed
- restart: must invalidate existing allocated check
- restart: store on existing check, but indicate pupil is allowed restart (update pupil flags)
- checkConfig: move data and functionality to dedicated microservice/function?
- checkNotifier: mtc_admin columns to support processing errors
- preparedCheck: should this be in redis with TTL?

## Decisions

- submitted checks
  - persisted as-is in an immutable state.
  - CheckCode/pupil UUID and SchoolUUID will be top level properties to use as composite key.
  - Compressed 'large' complete check is ~24KB
- check receiver:
  - message is received from the check-submitted queue
  - record is inserted into receivedCheck table
    - partition key: schoolUUID
    - record primary key: checkCode / pupilUUID (decision required)
    - checkData: compressed archive property value
    - dateReceived: current UTC datetime
    - dispatches message onto check-notification queue to indicate received
- check notifier:
  - notification types:
    - check-received
      - sql.mtc_admin.check.receivedByServerAt is updated to current UTC datetime
    - check-complete
      - sql.mtc_admin.check.complete set to true
      - sql.mtc_admin.check.completedAt set to current UTC datetime
    - processing-failure
      - sql.mtc_admin.check.processingFailed set to true
      - sql.mtc_admin.check.completedAt set to current UTC datetime
    - if sql operation fails or check is not found this information is recorded in sqlUpdateError column of receivedCheck record? (decision required)
    - the execution timeout of the function must take into consideration the potential for waits / retries on sql operations
- check validator function:
  - triggered by check-validation queue message
  - properties are validated against v2 schema
  - message is dispatched to check-marking queue via output binding
- check marker function:
  - message is received from unmarked-check queue
  - properties are validated against V1 schema (schoolid and checkCode)
  - receivedCheck entry is retrieved
  - check is marked
  - score is recorded in mark column
  - row is updated in receivedCheck table
  - if marking fails, error details are stored in markError column and row is updated


## Next steps

### Analysis day 27th Aug 2019
- Establish 'pupil state' design.
  - Add columns to pupil table?
  - have separate pupil state table?
  - eliminate pupil status function and infer state from pupil state
- Restarts
  - attach to pupil table directly
  - pupil restart table serves as a log/audit trail
  - bind to check on creation?
  - create check as part of restart procedure?
  - invalidate entire restart & check at end of day if not used?
  - is this OK with UX/business?

### Pupil Journey Meeting Friday 13th September 2019
- pupil logged on still required - not a status anymore
- when validation fails, notify teacher
  - sent from validation service to the check-notifier
- when marking fails, inform teacher
  - sent from marking service to the check-notifier

### Tech session Monday 16th September 2019
- checkConfig.  move to table storage?
- it is currently the authority on a checks used config
- what is the composite index? pupil uuid/check code

## Pupil API
consider converting to function.
input trigger would be http
2nd input binding would be table storage with filter to get message automatically
### why?
- less moving parts, part of a function app
- no docker/server to maintain
### why not?
- extra dev work
- aint broke, don't fix it
- serves on average at 130ms~

## pupil prefs
http function as a service for GET/POST/DELETE.
has its own dedicated data store, preferably redis or table storage.
pupil-spa would need credential challenge
### dependencies
- admin app (get/set prefs)
- pupil spa (set prefs)
- pupil api (get prefs)
### why?
- isolates data and functionality (true microservice)
- moves demand away from SQL
### why not?
- extra dev work
- ain't broke, don't fix it
- harder to report on
- breaks existing functionality

## pupil-login function
- existing function updates check table directly with logged in time
- existing submits pupil-status update message to queue
### changes
- create table storage 'pupilLogin'
  - partitionKey: pupilUUID
  - rowKey: checkCode
- remove pupil-status queue
- do not update sql

Should not influence pupil status, but should serve as a support element to acknowledge when pupil logged in.
illustrates the issue of combining the pupils current status with check status.

## check notifier function & queue
triggered by message on check-notification service bus queue.
responsible for updating mtc_admin.check with submission progress.
- check received
- check 'complete'
- check processing failures
  - sql.mtc_admin.check.receivedByServerAt is updated to current UTC datetime
    - if update fails or check is not found this information is recorded in sqlUpdateError column of receivedCheck record
    - the execution timeout of the function must take into consideration the potential for waits on the storage operations

## check-validator function & queue

triggered by a new message on the check-validation service bus queue.
Hydrates and validates an entry in the receivedCheck table.
uses complete-check schema to validate check has same top level properties
Records 'validatedAt' in UTC against the entry on completion.
Submits a check-marking message onto the queue after recording validation datetime.
Records a 'validationError' against the entry on failure.
submits 'check-notification' message to indidate validation failure (shares same 'processing failure' outcome with check-marking function)

### check-validation queue properties (currently service bus)
- Max size: 1GB (to be reviewed)
- TTL: 14 days
- Lock duration: 5 minutes
- Duplicate detection: enabled
- Duplicate detection window: 1 day
- Dead lettering on expiration: true
- Sessions/FIFO: false
- Partitioning: false

## check marker function & queue

triggered by a new message on the check-marking service bus queue.
Hydrates and marks an entry in the receivedCheck table.
records 'mark' against the entry on completion.
submits 'check-notification' message to indidate success/failure of marking (shares same 'processing failure' outcome with check-validator function)
Further actions to be defined, but will include signalling that check is ready for PS report and MI.

### check-marking queue properties
- Max size: 1GB (to be reviewed)
- TTL: 14 days
- Lock duration: 5 minutes
- Duplicate detection: enabled
- Duplicate detection window: 1 day
- Dead lettering on expiration: true
- Sessions/FIFO: false
- Partitioning: false
