language: node_js

dist: trusty

branches:
  only:
    - master

cache:
  yarn: true
  directories:
    - /home/travis/.rvm/
    - ${TRAVIS_BUILD_DIR}/admin/node_modules
#    - ${TRAVIS_BUILD_DIR}/pupil-api/node_modules
    - ${TRAVIS_BUILD_DIR}/pupil-spa/node_modules

env:
  matrix:
    - TEST_TYPE=admin-e2e-1
    - TEST_TYPE=admin-e2e-2
    - TEST_TYPE=admin-e2e-3
    - TEST_TYPE=pupil-e2e-1
    - TEST_TYPE=pupil-e2e-2
  global:
    - OVERRIDE_PIN_EXPIRY=true

node_js:
  - 8

addons:
  chrome: stable

services:
  - docker

sudo: required

before_install:
  - node ./deploy/should-it-build.js $TRAVIS_PULL_REQUEST
  - rvm reload && rvm use ruby 2.4.1
  - sudo apt-get install google-chrome-stable
  - ${TRAVIS_BUILD_DIR}/admin/bin/install-freetds.sh

install:
  - docker-compose up --build -d && sleep 30
  - docker info
  - cd ${TRAVIS_BUILD_DIR}/pupil-spa && travis_retry yarn install --frozen-lockfile
  - cd ${TRAVIS_BUILD_DIR}/admin && travis_retry yarn install --frozen-lockfile
# - cd ${TRAVIS_BUILD_DIR}/pupil-api && travis_retry yarn install --frozen-lockfile
  - cd ${TRAVIS_BUILD_DIR}/test/admin && gem install bundler --conservative && bundle install
  - cd ${TRAVIS_BUILD_DIR}/test/pupil && gem install bundler --conservative && bundle install
  - docker-compose logs
  - cd ${TRAVIS_BUILD_DIR}/admin && yarn migrate-sql

script:
  - if [[ "$TEST_TYPE" = admin-e2e-1 ]]; then cd ${TRAVIS_BUILD_DIR}/test/admin && ./admin_tests_1.sh; fi
  - if [[ "$TEST_TYPE" = admin-e2e-2 ]]; then cd ${TRAVIS_BUILD_DIR}/test/admin && ./admin_tests_2.sh; fi
  - if [[ "$TEST_TYPE" = admin-e2e-3 ]]; then cd ${TRAVIS_BUILD_DIR}/test/admin && ./admin_tests_3.sh; fi
  - if [[ "$TEST_TYPE" = pupil-e2e-1 ]]; then cd ${TRAVIS_BUILD_DIR}/test/pupil && ./pupil_spa_tests_1.sh; fi
  - if [[ "$TEST_TYPE" = pupil-e2e-2 ]]; then cd ${TRAVIS_BUILD_DIR}/test/pupil && ./pupil_spa_tests_2.sh; fi

after_script:
  - docker-compose down
