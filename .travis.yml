language: node_js
dist: trusty
branches:
  only:
  - master
cache:
  yarn: true
  directories:
  - "/home/travis/.rvm/"
  - "${TRAVIS_BUILD_DIR}/admin/node_modules"
  - "${TRAVIS_BUILD_DIR}/pupil-api/node_modules"
  - "${TRAVIS_BUILD_DIR}/functions/node_modules"
  - "${TRAVIS_BUILD_DIR}/pupil-spa/node_modules"
env:
  global:
  - OVERRIDE_PIN_EXPIRY=true
  - ENVIRONMENT_NAME=hpa-travis
  - FEATURE_USE_HPA=true
  - SQL_DATABASE=travis-ci
  - AUTH_URL=http://localhost:3003/auth
  - secure: eNQ7oPdxw3AhzBL0qg+M/nEzZa0vK4P0BG6usUJhX0BP2kqbwQNw9zyihiQzAwqLF9Npnfro1GLvDjcSzRqSOWoKJpLtG7Ze87LqusCKKJ35cMs1Xb8b42YJPrIliVgaLVK+1l6kj383xh/kjDM95NftH7dvyjPpXi1uCxz6NyvfQbp8a0ZRntp7/A+fL1UwUgjeF9v6JEyW6t/A3bvBuLmUkP1ArHPlFRvHUIEj7giE671b2nNsWVBOHzgH/bPnFlEbe+jTNcYGTshguILIIbNWbcIY4w5gzwja1VaMDdnAbdRNbPgIbeR+aRslq3qCACHTGrGU4QhwKb+SbYj4n0mc/Vbc4tAuUjocv9GS1Ziszs2Gpe2Vn8tu5XY1JC4CgWdXm/A0HQ/NSXvs0LIQsLIeNtJEdzrz3t3zVKZbQPYNO0tlDkz4jyW9i5CFGdGTOqVElsBTcVlHGeMdEUxy6EQ6oOjsrDPsnwOntl3ERHMrYrSP4XtjsVWXBIeXD9c0jmsERvRf14o0L1+0Vwpbo/1UBmrI5xtIeWxE84ljUh+ndQ8b4jgeyON0gDXavcPdQvCMjQKMKaYPtfdHiuWOHY/2HhMGnHMcpIbUBT/zKk4jr/6Yj0Z7CPo+gvEucX2DYKItex1zDL3g+NLavYkAB7UvKwMxSOj5m08qOu10VEE=
  - secure: LXdzM1Tf3EuIweD6iDJBfSZ1NibgC+DFz/gBWPx8DA+cpjwgl5c1C25EH0vOCj8p8TutL8WbsJ8Umn3sxCG3VfnghGbA9sYyKvme0F4aKAoNqz1eriOXKaE65dD4Jq17TMukf5Kl+sFAo7PRzIFj6Z5QtwwbSJBXQKfQjHu5P3t1k0ALyShruGcOs8PdeJ+S8zUMxS3YASY7xLzNVIK4qaI+xY4Ew8UpZH39kJJxoWFYrpxiv58ZP4r5W6EzeTTzUe0RLXTpKI2lEmOaKxO7W5Ax2r4qiN0km02d5V+gltzOqil8PpyPktINOqd4D1zaFhDHHW9sYH3K3my3do52GmLrLpfbiJJElJm3w6ff0zLoGi8IWCQBkqqv/snX5d//4JQ0shxCBMkIiSAIcKymjhYJ5SKVwq+3LRf/erMhuQgaE7w/Ew6+LL90M3L0trs819jCETXcW2rsGIkgrcX/alcz6W+q1D7pcVQZ+vdrUVhmXVfrvhVH/rAPGSbHjHFWzvBR+zURstirNLMKuk1SyBpyR9EMv7ZXgL6fkwSiMo0S595oXTJev2YbImm7tIA+oCE7PW01o5VPfFjMYuYJfsrK13WtoF/CF61rRtD21d+i8qORpCkRCYWsEufrb5vMrBFHai0rhXpWCzOYTcu7zK6NdmVffA031BBFDD4Cs+4=
  - secure: hrNaM8No5syQEIQiVbVjuo4AbwpgQ+qxlB5+IJWyPF2niWroh6q/zEkf+TnCx7MiLcz3sXCFiedKR2y+Fkvna2eablqbL5LZcbcSx1nMn5mBVnUtpIG0HZHcpBDrIC703aD1xuK2Baf4ZVO2VpevyTJO+/RRSF/wp5Cr61lvLjlpdchfFXenAQ5G5Fs64m7XpmI5PkdbdFEN89tP3lJz82/PudGLDIHK/Y34xgO/xCc5Ytvs5YnRNsMZH2DrB3Oq4Cj9OidqIu00vPgQA4ciHiZ6mkuyMbwU7QsOr34V3q8CnuRerLZil/S/bPdGti1ZIsHiKgHWdJsPkoOBbSlepBnx+UdeADXDfetvK85ebSEmrbpSfsCACvm3WD8CRddiUSt8jL+jiNiOZuhuGTUirVa8CuzS1TUNZUHZT2LQy9cP3bMrG3GA/2DtdeYPwKdQNOkwPCQMjxAa1AaIjZBhzTbJrfeJQQU52mSGazqYPKaI5LvyufKWyn5fcrEvubVabpynvnz8FHnbwOEqBdMk5ZKstBUj3w39g4UZisvCt7mICFDb8SvGISR2SUVbIt+jVOtBO2qiCMRuZ5+YVpK6mSN8Zc1CA9SK9/ugaOiIrMw8hY1gWiE0kBQWEMIGH8Z1oO9YgjXMNzkekzyuPwbbDog+iR2IJCrddodlVnljrb0=
  - secure: GI+4Y7Mj5iYnag9jc93t2Vk5zJKi74RHWwSy5059YDV3nx3NLivdthKvA/uvdCEqZP8VqCTVKpGjaMYQgbuxk9q6D4ulugSbczlIcrzilmiQSp9Q2kFSlb2yqREAcvzf674nIZ7CstSNdkNUMo2dC9kxou5gNGgLZ1TQ5yay7I4tbuMn78dOaGqAKZ56ZVLwW1ZKTnuCHOB5Tuvk4gYHcPrq113NPrWgl6EoZIkUogqOGfPXZNhRaVFOx2XqdOI0VubkiA2gvBWPt0n5WfxLeHGeZuRBmYbsC99NB5ol7Lp74DFmtGpjYve0pkpFxTFnYbIC1WG//QWvI+It/anidnvHZ8ElClsPj4FeSmhZ1Ft4rI7k0B/ZWIYX/yWonep9iJJDTUIjqr/19v8biO8O6c8zYoKhqgN2GASlqIKYz81D/JUUNWBKGBGepBGKvLfGXWl5OIw6Sq3/GS5QfgQ6sCzmnEfthyuoINrExj0J/dvsdGqrIWEH5Pb8QN8raP2cUE5DrbNUaA2FlF1MbjDIa6l7qsNmqs+poLfNEr3526DioD4bBhaqgiyAqpMTPkrmlIZuNhc+XqS3FdqJ2+jX3VaPsefF609g39kEXI3j0sPhIvPoFPpGfzXlrUd40KuQlzgBqHWGN+iLoc4horA2T2ZRcPpqRq+7qPpj+W6jztc=
  - secure: AW4QPwdhzzw3CFGVbLNrdCZIxAAMH/MepzRV8BEsqNAItEW15E8siJVWcFjPTmGxrLAJTjP3+rrFMe8ktOsQIilGOqjh/ZgjxBBDROAgiz2WbQ0FkEa3NkCpgOuqJ0SrIDIiNQJhjbu/ckurWX1kprwWDVCE71qG3BFiHQvVv/XLKv3thGzeswx59dhBQ6BSTo6ZWDH4zffzw5yuEDlVrRk97KHseXgxzHi/uhx9TpKlYyS7IfPLXkWm35BuhLmFjvUBekit+iFM74Dii1PzUMrNmfNftebj+UyiPWhSOcHqRChizPvlU998a5yRDNz60m4hDBzA4+iuReKvBzKOH+w0eM8ndjWwIOsNwrz5svLlMYFo4TTwpn1A2lWzpqokTnI9u36LdsG8bMvVcrSZqpyXMY3ujgNms2Cc+L3B/clW4srpomgXlqIdmhgYt+A6s8rYmXXLgq7SnuUpc4Gcqu+wYTsHs3q20N72eWojg1G05rdO4sW0iTgNpj/rQQcXn+UoCNBb4FgKId5Pmn8h5oMDVAn5qozKKOKY0UgmhP+z2obi2FNN40sYkEI/v5d41Fzc0aJEAnRk5Lm/dw91+ZVSij5/qaZsUEQe3s532KIOmfwF6tge1Re147ap8F97N2yGk7Mv7j6YZaTp3szdMXgeQSUrTerug/lhPz8Qzuo=
  - secure: nZLoMMLdFNhucPT/W7EYHuPDuiMJ7L9aa7WwmIJkSw5cDJkdoCAmv+VdgYMCxi4I6yWsiuf/rDSJoazx7s6kMcUn2geCGhjFGnAAb5mitTe+qSZOgL8gazrBUZgVskb0xJKnX7heCtf5f035+ZNscDj5d0FWpqjbPdiqf/kJw53xTCowSR866dP+jUNOL3wJraqlVi6N17ARGYIVM3A5Cv1hJLuKZ275mlURbcfyIdnCST0og2ryvx/OIExtWRKFRHhbvrImbjsP8tRojAjZms4odiaUcro1Jz/vv77F7ATEfTx0/nnwyiZzYTXsdx06cRQ6qVEhvqWpTJHOR+a7wd9BJV3zsn9NnQXnnGV9zz/A/X6TVAnUbjVBFT0DegW1Y+icKeu/JmMG+6mA4DHD0FsKOQoHBs8tMsn2t3uuoLU22vM//+4QvsqX1V/RrOhj/fvJ22xH4vUUy9FkvP0LBspACRnz8D7DHh02hB7TZEFJuIUgidbcyfWdxhH4657lIKaCQcyzX4PO5qMcID9BfsZdZRKZW0aO8Euve0nSqPo1UW2flUxQ4o9DT5upFpWtbQ1kCBEVn4EbpxbVFCibB83u9GB2wYVegnBjFocZ7RfyW5DR6fQqHz2HmHMmHCe9hRlMDI7UJHx2ZdQ0qTqKvkiDlbUbmvmNIwYFfuuKVUg=
  - secure: Xb3V8Ff0Np95h1Gu5Z9RMd/HghzyFTUfADPgWN4Ki0BgzFoRs/p9ucnUq91L4wuiBXD6fhPNG5RFdNzoD5v6lte3KvLVGzeFK1o9pTovqsNATAuASe91R+rpeveTGUQlqPpDRpI4S6IF+Aw0koQjE+rWq7wCkkFhk5x3rHHcELLO0a73HLW/oRgVEcw0gfB4A2FupaqXNOfs6V7BbsBNiyReDmomxqBrmlI42LtpPRWv93SfDSNHKVyujY5rQOypHdotULOjZxlgPm8mXNBtTr24sYDI2YEFhEF4jSKrMUyp2nM0qWhi77Njwywkxmy8hM89cVBgQZmwBbJHJv8Q+yjnbz+Bd6y2FM9WcNFGymSbq4H3GrJ2c0dBpqJAlO6Ea2p5cGc2bFdHYhW/tP5fSipRQP1sKiu2tnx1qqSDv3/WL8/t7ln7RGZ8KjkFqmYHf4aMqcwfdsMO5/N4+7TIBabzarnjuTxs/5iLLvyfe6TCQTbkG2KyGchotzx3K6qgtWBUjZYorjVyhAfh99PWi9IfRpfUNQVVSFTwMmqcDdzkI8haWDGWZkn498reBygY9gv5iDQQrConuQ1Nef0K6fNLGc7c3l6x5VsxkTSHtf2TMvuemfjwppifDM8tshnJlKPybZzv/C8ukK8GNdcPf3P44IrtSlyW/JKG3yRi5VM=
  - secure: WLLaEo5xWjn3JvGciS9BUSjHewVSzZSzZX5iQlAwFOhkIPswLSnrouVhUr51kpEzdPFWR+c+L4OXxPg8CwH+LHVd0wBKZv9PwGTw+C9TiNyNThh0vzzRZP3kedMB5YYnt9MR8cPw05AOeAbB+gcRo5HaqwDRWdk8sSYsMx7DyydsdFLJrpJkE2efiG0tbT87MxtB+sDh0w3M1ar+hW00urGFgHvU+QxkCDQALbzXIpeNoTwOI4dLSKB+joG5oXNAk3XY+Awhv1qy5RavmTP+xPc1U49RywDitQe1nk4R+CcB9rouIzh6FoYRfVAiUcfpA+7/YHB8vBKjJJCqaNv9FokF59mEvo+C9ct71usyPrhBnWpN4tobsK4dUrC2lrAfnHW1xEtwgGNmM2QXH3TkMozpy/y3Pi1sBwA1G+/N6KMDQhmssybNHGrbqFX3XVVGm8MUNpLhLg4K09EwlcPjs8E5kpEIgY2yY55Xs/C+AbF5UfIo0YsOoZL0vjM6h4HsZyRJG/vIF8jQtkD+2Nk3aJXc5sCqKmTLe1YA4Xt1MA+onUmr/2xNb/Doutfo2foMr77i0/WAIfcn07B2bbgiPYkJ/3efhyYlBXCN4n0rxEBPLPdCmbV7HeiUkyr0IYwohKNz2fYIvb1sy1st561hO/NG4M978+Txl32S7j17qfM=
node_js:
- 8
addons:
  chrome: stable
services:
- docker
sudo: required
before_install:
- node ./deploy/should-it-build.js $TRAVIS_PULL_REQUEST
- rvm reload && rvm use ruby 2.4.1
- sudo apt-get install google-chrome-stable
- "${TRAVIS_BUILD_DIR}/admin/bin/install-freetds.sh"
install:
- docker-compose -f docker-compose.functions.yml up --build -d && sleep 30
- docker info
- cd ${TRAVIS_BUILD_DIR}/pupil-spa && travis_retry yarn install --frozen-lockfile
- cd ${TRAVIS_BUILD_DIR}/pupil-api && travis_retry yarn install --frozen-lockfile
- cd ${TRAVIS_BUILD_DIR}/admin && travis_retry yarn install --frozen-lockfile
- cd ${TRAVIS_BUILD_DIR}/test/admin-hpa && gem install bundler --conservative && bundle
  install
- cd ${TRAVIS_BUILD_DIR}/test/pupil-hpa && gem install bundler --conservative && bundle
  install
- docker-compose logs
- cd ${TRAVIS_BUILD_DIR}/admin && yarn migrate-sql
script:
- cd ${TRAVIS_BUILD_DIR}/test/pupil-hpa && ./hpa_travis_reduced.sh;
after_script:
- docker-compose down
