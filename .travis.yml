language: node_js

dist: trusty

branches:
  only:
    - master

cache:
  yarn: true
  directories:
    - /home/travis/.rvm/
    - ${TRAVIS_BUILD_DIR}/admin/node_modules
    - ${TRAVIS_BUILD_DIR}/pupil-api/node_modules
    - ${TRAVIS_BUILD_DIR}/functions/node_modules
    - ${TRAVIS_BUILD_DIR}/pupil-spa/node_modules

env:
  matrix:
    - TEST_TYPE=admin-e2e-1
    - TEST_TYPE=admin-e2e-2
    - TEST_TYPE=admin-e2e-3
    - TEST_TYPE=pupil-e2e-1
    - TEST_TYPE=pupil-e2e-2
  global:
    - OVERRIDE_PIN_EXPIRY=true
    - ENVIRONMENT_NAME=hpa-travis
    - secure: "FGAPL/NS6XUE4/Xph4sKHuET+JOixzWr+bot4RMwzeVwsxVCOQCfk4iYqtCES+07l0sM91XoRfj60Y6kRYztyDFoGQNOT/PF+l8+EHtlFitdcUiF4xZN4w4ciOgVemrMq6uDY9l7L/D2l/R3O1oOahXMZY+bOuGlIkaLoLN1tk50yI2z+pON9MLRJj54nj785EXI4MXbCwURx9ZlDZ+rwDw8WxqF5r0jEQxmnE90OWg5z8Upc7d4MezbRJWIcR1kqTC0AasQD7ZNdhNNEjNlcOKVGscVJhWVeiaO5+6Gjek6je/IjUgsVIeTQLrYb6ujfgYjK7HAHq454rqdZTutoEURtAZpknedfDKyNE1RCFiCRihru1MI2y7Dkzw+psxPsRhiwVy/XHg6AUYTX99wsztg2u+l+szcpREaQtKWprAMqUrdVgEdx9dah+Sx8csmxRMcqgI/wro/j/ob9TI5R4Jy6z/h9NbHwASW2b7Fj8Ec+/sgQmXuDPL7CCS/4vIWXgzF450y9us7O+mlERaopBRk5JPE7lLOZ5xmXfLENH+dyfxAFKBRaWaNW1Wdv5eaE7XPBQT16/Ex629pcA8tqjB1cGTqvpEZ0ax5FKRi2aMngwyyOnVOmJa2ENw0lb03MxzSGZsgBs+CbJ73N77KluGvSgiSRvV3fK09D0ajs7U="

node_js:
  - 8

addons:
  chrome: stable

services:
  - docker

sudo: required

before_install:
  - node ./deploy/should-it-build.js $TRAVIS_PULL_REQUEST
  - rvm reload && rvm use ruby 2.4.1
  - sudo apt-get install google-chrome-stable
  - ${TRAVIS_BUILD_DIR}/admin/bin/install-freetds.sh

install:
  - docker-compose up --build -d && sleep 30
  - docker info
  - cd ${TRAVIS_BUILD_DIR}/pupil-spa && travis_retry yarn install --frozen-lockfile
  - cd ${TRAVIS_BUILD_DIR}/pupil-api && travis_retry yarn install --frozen-lockfile
  - cd ${TRAVIS_BUILD_DIR}/functions && travis_retry yarn install --frozen-lockfile
  - cd ${TRAVIS_BUILD_DIR}/admin && travis_retry yarn install --frozen-lockfile
  - cd ${TRAVIS_BUILD_DIR}/test/admin && gem install bundler --conservative && bundle install
  - cd ${TRAVIS_BUILD_DIR}/test/pupil && gem install bundler --conservative && bundle install
  - docker-compose logs
  - cd ${TRAVIS_BUILD_DIR}/admin && yarn migrate-sql

script:
  - if [[ "$TEST_TYPE" = admin-e2e-1 ]]; then cd ${TRAVIS_BUILD_DIR}/test/admin && ./admin_tests_1.sh; fi
  - if [[ "$TEST_TYPE" = admin-e2e-2 ]]; then cd ${TRAVIS_BUILD_DIR}/test/admin && ./admin_tests_2.sh; fi
  - if [[ "$TEST_TYPE" = admin-e2e-3 ]]; then cd ${TRAVIS_BUILD_DIR}/test/admin && ./admin_tests_3.sh; fi
  - if [[ "$TEST_TYPE" = pupil-e2e-1 ]]; then cd ${TRAVIS_BUILD_DIR}/test/pupil && ./pupil_spa_tests_1.sh; fi
  - if [[ "$TEST_TYPE" = pupil-e2e-2 ]]; then cd ${TRAVIS_BUILD_DIR}/test/pupil && ./pupil_spa_tests_2.sh; fi

after_script:
  - docker-compose down
