[![Build Status](https://travis-ci.org/DFEAGILEDEVOPS/MTC.svg?branch=master)](https://travis-ci.org/DFEAGILEDEVOPS/MTC)
[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg)](http://standardjs.com)
[![Codacy Badge](https://api.codacy.com/project/badge/Grade/9f1ef3308c8c407284322926f501d537)](https://www.codacy.com/app/js_4/MTC?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=DFEAGILEDEVOPS/MTC&amp;utm_campaign=Badge_Grade)
[![CircleCI](https://circleci.com/gh/DFEAGILEDEVOPS/MTC.svg?style=svg)](https://circleci.com/gh/DFEAGILEDEVOPS/MTC)

# Multiplication Tables Check (MTC) Project

Requires Docker 17.05 or later.

## Docker Compose

There are 3 docker files...

### docker-compose.yml
The default, which runs just SQL Server (main data store) and MongoDB (express session store)
Stand up the database containers with: `docker-compose up`

### docker-compose.admin-test.yml and docker-compose.pupil-test.yml
Runs SQL Server, MongoDB, all web applications, and the pupil and admin test suites as separate containers.
This compose file depends on `docker-compose.yml` and should not be run directly.
To stand up the tests, app and db containers run either `./run-compose-admin-test-suite.sh` or `./run-compose-pupil-test-suite.sh`

### run-compose-admin-test-suite.sh
In order to run the admin test containers to completion, and exit with a non-zero exit code during CI, execute the `run-compose-admin-test-suite.sh` bash script, which will monitor the compose containers for non-zero exit codes (typically generated by the test suites when they fail), tear down all containers and exit appropriately.

### run-compose-pupil-test-suite.sh
In order to run the pupil test containers to completion, and exit with a non-zero exit code during CI, execute the `run-compose-pupil-test-suite.sh` bash script, which will monitor the compose containers for non-zero exit codes (typically generated by the test suites when they fail), tear down all containers and exit appropriately.


Once the full compose stack is up and running, you can browse to....

* http://localhost:3001 (Admin App)
* http://localhost:80 (Pupil App)

The MTC solution consists of the following projects...

- Pupil Check Application (`/pupil-spa/`) Angular SPA
- Check Administration Application (`/admin/`) Express MVC application
- Electron Container for Pupil Check Application (`/electron/`) Electron shell for Pupil Check Application (Obsolete)

See each projects readme for app specifics.

### Building Docker Images

to build an individual docker image, navigate to the relevant app folder and run...

`docker build -t <image name> .`

where `<image-name>` is a friendly name that allows you to easily identify the image. 

[Markdown Cheatsheet](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet)

### Using microservices

To make the pupil-spa use the auth microservice instead of the API in admin, change the AUTH_URL environment variable in `pupil-spa/Dockerfile` and the `docker-compose.*.yml` files relevant for pupil-spa

## ICT Survey Setup

You need a storage account to be set up. For the ICT Survey setup, create
two tables:

- `survey-feedback`
- `connection-tests`

...and one blob container:

- `connection-test`

(These are examples that can be changed, as long as they're consistent
with the environment variables).

### Table setup

- Set up the table names in the env vars:
  - `TEST_TABLE_NAME`
  - `FEEDBACK_TABLE_NAME`
- Get a SAS token for both tables, and set the token and URL in the env
  vars:
  - `TEST_TABLE_URL` and `FEEDBACK_TABLE_URL` should look
    like `<accountname>.table.core.microsoft.net/`
  - `TEST_SAS_TOKEN` and `FEEDBACK_SAS_TOKEN` for the tokens generated
    previously.
- Update CORS for the tables.

Note: To create the SAS token:
  - Right-click on the table name in Storage Explorer
  - Choose ‘Get Shared Access Signature’
  - Create one with only ‘Add’ ticked in the checkboxes
    - Start time should be the current time, or one in the past; and
      expiry time should be sufficiently far in the future.

Note: To set CORS:
  - Right-click on ‘Tables’ in Storage Explorer
  - Choose ‘Configure CORS Settings’, and then Add
    - Allowed origins: `*` (can be `*` for testing; should be the
      official URL of the SPA app in production)
    - Methods: `POST`
    - Headers: `*`
    - Max age: `3600`

### Blob setup:

- Generate the container and set up the name and URL in the env vars:
  - `TEST_BLOB_URL` should look like
    `<accountname>.blob.core.microsoft.net/`
  - `TEST_BLOB_STORAGE_NAME` should be `connection-test` (if not
    changed previously)
- Set the public access level to ‘public read access for blobs only’
- Set up CORS as above:
  - Allowed origins: `*` (can be `*` for testing; should be the
    official URL of the SPA app in production)
  - Allowed methods: `GET`
  - Allowed headers: `*`
  - Exposed headers: `*`
- Create the files locally and upload them in the root of the blob
storage using something like this:

```bash
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 134217728 > 128mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 67108864 > 64mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 33554432 > 32mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 16777216 > 16mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 8388608 > 8mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 4194304 > 4mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 2097152 > 2mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 1048576 > 1mb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 524288 > 512kb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 262144 > 256kb.text
cat /dev/urandom | LC_ALL=C tr -dc "[:alnum:]" | head -c 131072 > 128kb.text
```

After everything, the environment should look similar to this:

```bash
TEST_TABLE_URL='https://<accountname>.table.core.windows.net/'
TEST_TABLE_NAME='connection-tests'
TEST_SAS_TOKEN='?st=<token>'
FEEDBACK_TABLE_URL='https://<accountname>.table.core.windows.net/'
FEEDBACK_TABLE_NAME='survey-feedback'
FEEDBACK_SAS_TOKEN='?st=<token>'
TEST_BLOB_URL='https://<accountname>.blob.core.windows.net/'
TEST_BLOB_STORAGE_NAME='connection-test'
```

### Checking results in the Storage Explorer

After any messages are inserted into the tables, double-click on the
tblae name that you want to check in Storage Explorer, and they should
appear in a container on the right. Double-clicking on a specific row
will display that specific message.

# Enabling AMQP 1.0 in Rabbit MQ

In order to use the npm package `amqp10` with Rabbit MQ the `rabbitmq_amqp1_0` plugin must be enabled within Rabbit MQ.

This is achieved by mapping the local `rabbit_enabled_plugins` file to `etc/rabbitmq/` within the container.
