[![Build Status](https://travis-ci.org/DFEAGILEDEVOPS/MTC.svg?branch=master)](https://travis-ci.org/DFEAGILEDEVOPS/MTC)
[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg)](http://standardjs.com)
[![Codacy Badge](https://api.codacy.com/project/badge/Grade/9f1ef3308c8c407284322926f501d537)](https://www.codacy.com/app/js_4/MTC?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=DFEAGILEDEVOPS/MTC&amp;utm_campaign=Badge_Grade)
[![CircleCI](https://circleci.com/gh/DFEAGILEDEVOPS/MTC.svg?style=svg)](https://circleci.com/gh/DFEAGILEDEVOPS/MTC)

# Multiplication Tables Check (MTC) Project

Requires Docker 17.05 or later.

## Docker Compose

There are 3 docker files...

### docker-compose.yml
The default, which runs just SQL Server (main data store) and MongoDB (express session store)
Stand up the database containers with: `docker-compose up`

### docker-compose.admin-test.yml and docker-compose.pupil-test.yml
Runs SQL Server, MongoDB, all web applications, and the pupil and admin test suites as separate containers.
This compose file depends on `docker-compose.yml` and should not be run directly.
To stand up the tests, app and db containers run either `./run-compose-admin-test-suite.sh` or `./run-compose-pupil-test-suite.sh`

### run-compose-admin-test-suite.sh
In order to run the admin test containers to completion, and exit with a non-zero exit code during CI, execute the `run-compose-admin-test-suite.sh` bash script, which will monitor the compose containers for non-zero exit codes (typically generated by the test suites when they fail), tear down all containers and exit appropriately.

### run-compose-pupil-test-suite.sh
In order to run the pupil test containers to completion, and exit with a non-zero exit code during CI, execute the `run-compose-pupil-test-suite.sh` bash script, which will monitor the compose containers for non-zero exit codes (typically generated by the test suites when they fail), tear down all containers and exit appropriately.


Once the full compose stack is up and running, you can browse to....

* http://localhost:3001 (Admin App)
* http://localhost:80 (Pupil App)

The MTC solution consists of the following projects...

- Pupil Check Application (`/pupil-spa/`) Angular SPA
- Check Administration Application (`/admin/`) Express MVC application
- Electron Container for Pupil Check Application (`/electron/`) Electron shell for Pupil Check Application (Obsolete)

See each projects readme for app specifics.

### Building Docker Images

to build an individual docker image, navigate to the relevant app folder and run...

`docker build -t <image name> .`

where `<image-name>` is a friendly name that allows you to easily identify the image. 

[Markdown Cheatsheet](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet)

### Using microservices

To make the pupil-spa use the auth microservice instead of the API in admin, change the AUTH_URL environment variable in `pupil-spa/Dockerfile` and the `docker-compose.*.yml` files relevant for pupil-spa

# Enabling AMQP 1.0 in Rabbit MQ

In order to use the npm package `amqp10` with Rabbit MQ the `rabbitmq_amqp1_0` plugin must be enabled within Rabbit MQ.

There have been difficulties getting this plugin enabled via docker compose as [described here](https://github.com/docker-library/rabbitmq/issues/260)

The current workaround is to attach terminal to the running RabbitMQ container and manually execute the enable plugin command, as follows:

`docker exec -i -t ef0  /bin/bash` 

(where `ef0` is the first 3 digits of the hash of the running Rabbit MQ container)

Once connected, run the following:

`rabbitmq-plugins enable rabbitmq_amqp1_0`

The output should be similar to...

```
The following plugins have been configured:
  rabbitmq_amqp1_0
Applying plugin configuration to rabbit@ef093666a397...
The following plugins have been enabled:
  rabbitmq_amqp1_0

started 1 plugins.
```
